<?xml version="1.0" encoding="UTF-8"?>
<custom-sql>
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[COLUMN-NAMES-0]">	
		<![CDATA[
			count(opencps_processorder.processOrderId) AS COL0
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[DATA-TYPES-0]">	
		<![CDATA[
			INTEGER
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[COLUMN-NAMES-1]">	
		<![CDATA[
			opencps_processorder.processOrderId AS COL0,
			count(opencps_processorder.processOrderId) AS COL1,
			opencps_processorder.govAgencyCode AS COL2,
			d.itemCode AS COL3, 
			d.treeIndex AS COL4,
			g.treeIndex AS COL5,
			g.itemCode AS COL6
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[DATA-TYPES-1]">	
		<![CDATA[
			LONG,
			INTEGER,
			STRING,
			STRING,
			STRING,
			STRING,
			STRING
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[COLUMN-NAMES-2]">	
		<![CDATA[
			opencps_processorder.processOrderId AS COL0,
			count(opencps_processorder.processOrderId) AS COL1,
			opencps_processorder.govAgencyCode AS COL2,
			g.treeIndex AS COL3,
			g.itemCode AS COL4
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[DATA-TYPES-2]">	
		<![CDATA[
			LONG,
			INTEGER,
			STRING,
			STRING,
			STRING
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[received]">	
		<![CDATA[
			WHERE
				(opencps_processorder.groupId = ?)
			AND
				(month(opencps_dossier.receiveDatetime) = ?)
			AND
				(year(opencps_dossier.receiveDatetime) = ?)
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[finished]">	
		<![CDATA[
			WHERE
				(opencps_processorder.groupId = ?)
			AND
				(opencps_dossier.delayStatus = ?)
			AND
				(month(opencps_dossier.finishDatetime) = ?)
			AND
				(year(opencps_dossier.finishDatetime) = ?)
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.[processing]">	
		<![CDATA[
			WHERE
				(opencps_processorder.groupId = ?)
			AND
				(opencps_dossier.delayStatus = ?)
			AND
				(opencps_dossier.finishDatetime IS NULL)
			AND 
				(month(opencps_dossier.receiveDatetime) <= ?)
			AND
				(year(opencps_dossier.receiveDatetime) = ?)
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.generalStatistics">	
		<![CDATA[
	    	SELECT 
				$COLUMNS$
			FROM 
				opencps_processorder
			INNER JOIN 
				opencps_dossier
			ON 
				opencps_processorder.dossierId = opencps_dossier.dossierId
    
				$FILTER$
				
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.statisticsByDomain">	
		<![CDATA[
	    	SELECT 
				$COLUMNS$
			FROM 
				opencps_processorder
			INNER JOIN 
				opencps_dossier
			ON 
				opencps_processorder.dossierId = opencps_dossier.dossierId
    
			INNER JOIN 
			(
				SELECT 
					opencps_serviceinfo.serviceinfoId, 
					opencps_dictitem.itemCode, 
					opencps_dictitem.treeIndex
				FROM 
					opencps_serviceinfo
				INNER JOIN
					opencps_dictitem
				ON
					opencps_serviceinfo.domainCode = opencps_dictitem.dictItemId
				INNER JOIN
					opencps_dictcollection
				ON
					opencps_dictitem.dictCollectionId = opencps_dictcollection.dictCollectionId
				WHERE 
					opencps_dictcollection.collectionCode = 'SERVICE_DOMAIN'
			) AS d

			ON
				opencps_processorder.serviceInfoId = d.serviceinfoId
			INNER JOIN 
			(
				SELECT
					opencps_dictitem.itemCode, 
					opencps_dictitem.treeIndex
				FROM 
					opencps_dictitem
				INNER JOIN 
					opencps_dictcollection
				ON 
					opencps_dictitem.dictCollectionId = opencps_dictcollection.dictCollectionId
				WHERE
					opencps_dictcollection.collectionCode = 'GOVERNMENT_AGENCY'
			) AS g
				 
			ON 
				opencps_processorder.govAgencyCode = g.itemCode
			
				$FILTER$
				
			GROUP BY 
				d.itemCode, opencps_processorder.govAgencyCode;
			
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.statisticsByGovagency">	
		<![CDATA[
	    	SELECT 
				$COLUMNS$
			FROM 
				opencps_processorder
			INNER JOIN 
				opencps_dossier
			ON 
				opencps_processorder.dossierId = opencps_dossier.dossierId
   
			INNER JOIN 
			(
				SELECT
					opencps_dictitem.itemCode, 
					opencps_dictitem.treeIndex
				FROM 
					opencps_dictitem
				INNER JOIN 
					opencps_dictcollection
				ON 
					opencps_dictitem.dictCollectionId = opencps_dictcollection.dictCollectionId
				WHERE
					opencps_dictcollection.collectionCode = 'GOVERNMENT_AGENCY'
			) AS g
				 
			ON 
				opencps_processorder.govAgencyCode = g.itemCode
			
				$FILTER$
				
			GROUP BY 
				opencps_processorder.govAgencyCode;
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.getMonths">	
		<![CDATA[
	    	SELECT 
				DISTINCT opencps_dossierstatistics.month AS COL0
			FROM 
				opencps_dossierstatistics
			WHERE
				(groupId = ?)
			AND 
				(opencps_dossierstatistics.year = ?)
			ORDER BY
				opencps_dossierstatistics.month;
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.getStatsByDomain">	
		<![CDATA[
	    	SELECT 
				opencps_dossierstatistics.*
			FROM 
				opencps_dossierstatistics
			WHERE
				(groupId = ?)
			AND 
				(opencps_dossierstatistics.domainCode != '')
			AND 
				(opencps_dossierstatistics.govAgencyCode = '')
			AND 
				(opencps_dossierstatistics.administrationLevel = 0)
			ORDER BY
				opencps_dossierstatistics.month;
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.getStatistics">	
		<![CDATA[
	    	SELECT 
				opencps_dossierstatistics.*
			FROM 
				opencps_dossierstatistics
			WHERE
				(groupId = ?)
			AND 
				(opencps_dossierstatistics.domainCode = ?)
			AND 
				(opencps_dossierstatistics.govAgencyCode = ?)
			AND 
				(opencps_dossierstatistics.administrationLevel = ?)
			AND 
				$FILTER$
			ORDER BY
				opencps_dossierstatistics.year ASC, opencps_dossierstatistics.month ASC;
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.getStatsByGovAndDomain">	
		<![CDATA[
	    	SELECT 
				opencps_dossierstatistics.*
			FROM 
				opencps_dossierstatistics
			WHERE
				(groupId = ?)
			AND 
				(opencps_dossierstatistics.domainCode = ?)
			AND 
				(opencps_dossierstatistics.govAgencyCode = ?)
			AND 
				(opencps_dossierstatistics.administrationLevel = ?)
			AND 
				$FILTER$
			ORDER BY
				opencps_dossierstatistics.year ASC, opencps_dossierstatistics.month ASC;
		]]>
	</sql>
	
	<!-- new algorithm -->
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.getStatisticsByServiceDomain.[received]">	
		<![CDATA[
			WHERE
				(d.groupId = ?)
			AND
				(month(d.receiveDatetime) = ?)
			AND
				(year(d.receiveDatetime) = ?)
			AND 
				(sc.domainCode = ?)
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.getStatisticsByServiceDomain.[finished]">	
		<![CDATA[
			WHERE
				(d.groupId = ?)
			AND
				(d.delayStatus = ?)
			AND
				(month(d.finishDatetime) = ?)
			AND
				(year(d.finishDatetime) = ?)
			AND 
				(sc.domainCode = ?)
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.getStatisticsByServiceDomain.[processing]">	
		<![CDATA[
			WHERE
				(d.groupId = ?)
			AND
				(d.delayStatus = ?)
			AND
				(d.finishDatetime IS NULL)
			AND 
				(month(d.receiveDatetime) <= ?)
			AND
				(year(d.receiveDatetime) = ?)
			AND 
				(sc.domainCode = ?)
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierReceivedByServiceDomain">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year,
				sc.domainCode
			FROM 
				opencps_dossier AS d
			INNER JOIN 
				opencps_service_config AS sc
			ON 
				d.serviceConfigId = sc.serviceConfigId
			WHERE
				(d.groupId = ?)
			AND
				(month(d.receiveDatetime) = ?)
			AND
				(year(d.receiveDatetime) = ?)
			AND 
				(sc.domainCode = ?)
			GROUP BY
				d.govAgencyCode;
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierProcessingByServiceDomain">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year,
				sc.domainCode
			FROM 
				opencps_dossier AS d
			INNER JOIN 
				opencps_service_config AS sc
			ON 
				d.serviceConfigId = sc.serviceConfigId
			
			WHERE
				(d.groupId = ?)
			AND
				(d.finishDatetime IS NULL)
			AND 
				((month(d.receiveDatetime) <= ? AND year(d.receiveDatetime) = ?) OR (year(d.receiveDatetime) < ?))
			AND 
				(sc.domainCode = ?)
			AND
				(d.delayStatus = ?)
				
			GROUP BY
				d.govAgencyCode;
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierProcessingButFinishedAtAnotherTimeByServiceDomain">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year,
				sc.domainCode
			FROM 
				opencps_dossier AS d
			INNER JOIN 
				opencps_service_config AS sc
			ON 
				d.serviceConfigId = sc.serviceConfigId
			
			WHERE
				(d.groupId = ?)
			AND
				((month(d.finishDatetime) > ? AND year(d.finishDatetime) = ?) OR year(d.finishDatetime) > ?)
			AND 
				((month(d.receiveDatetime) <= ? AND year(d.receiveDatetime) = ?) OR (year(d.receiveDatetime) < ?))
			AND 
				(sc.domainCode = ?)

			GROUP BY
				d.govAgencyCode;
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierFinishedByServiceDomain">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year,
				sc.domainCode
			FROM 
				opencps_dossier AS d
			INNER JOIN 
				opencps_service_config AS sc
			ON 
				d.serviceConfigId = sc.serviceConfigId
				
			WHERE
				(d.groupId = ?)
			AND
				(month(d.finishDatetime) = ?)
			AND
				(year(d.finishDatetime) = ?)
			AND 
				(sc.domainCode = ?)
			AND
				(d.delayStatus = ?)
			
			GROUP BY
				d.govAgencyCode;
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierReceivedByGovAgency">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
			FROM 
				opencps_dossier AS d
			
			WHERE
				(d.groupId = ?)
			AND
				(month(d.receiveDatetime) = ?)
			AND
				(year(d.receiveDatetime) = ?)
			AND 
				(d.govAgencyCode = ?)
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierProcessingByGovAgency">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
				
			FROM 
				opencps_dossier AS d
			WHERE
				(d.groupId = ?)
			AND
				(d.finishDatetime IS NULL)
			AND 
				((month(d.receiveDatetime) <= ? AND year(d.receiveDatetime) = ?) OR (year(d.receiveDatetime) < ?))
			AND 
				(d.govAgencyCode = ?)
			AND
				(d.delayStatus = ?)
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierProcessingButFinishedAtAnotherTimeByGovAgency">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
			FROM 
				opencps_dossier AS d
			
			WHERE
				(d.groupId = ?)
			AND
				((month(d.finishDatetime) > ? AND year(d.finishDatetime) = ?) OR year(d.finishDatetime) > ?)
			AND 
				((month(d.receiveDatetime) <= ? AND year(d.receiveDatetime) = ?) OR (year(d.receiveDatetime) < ?))
			AND 
				(d.govAgencyCode = ?)
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierFinishedByGovAgency">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				d.govAgencyCode, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
			FROM 
				opencps_dossier AS d
			WHERE
				(d.groupId = ?)
			AND
				(month(d.finishDatetime) = ?)
			AND
				(year(d.finishDatetime) = ?)
			AND 
				(d.govAgencyCode = ?)
			AND
				(d.delayStatus = ?)
		]]>
	</sql>
	
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierReceived">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
			FROM 
				opencps_dossier AS d
			
			WHERE
				(d.groupId = ?)
			AND
				(month(d.receiveDatetime) = ?)
			AND
				(year(d.receiveDatetime) = ?)
		]]>
	</sql>
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierProcessing">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
				
			FROM 
				opencps_dossier AS d
			WHERE
				(d.groupId = ?)
			AND
				(d.finishDatetime IS NULL)
			AND 
				((month(d.receiveDatetime) <= ? AND year(d.receiveDatetime) = ?) OR (year(d.receiveDatetime) < ?))
			AND
				(d.delayStatus = ?)
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierProcessingButFinishedAtAnotherTime">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
			FROM 
				opencps_dossier AS d
			
			WHERE
				(d.groupId = ?)
			AND
				((month(d.finishDatetime) > ? AND year(d.finishDatetime) = ?) OR year(d.finishDatetime) > ?)
			AND 
				((month(d.receiveDatetime) <= ? AND year(d.receiveDatetime) = ?) OR (year(d.receiveDatetime) < ?))
			
		]]>
	</sql>
	
	
	<sql id="org.opencps.statisticsmgt.service.persistence.DossiersStatisticsFinder.doStatsDossierFinished">	
		<![CDATA[
	    	SELECT 
				count(*) AS total, 
				month(d.receiveDatetime) AS month, 
				year(d.receiveDatetime) AS year
			FROM 
				opencps_dossier AS d
			WHERE
				(d.groupId = ?)
			AND
				(month(d.finishDatetime) = ?)
			AND
				(year(d.finishDatetime) = ?)
			
			AND
				(d.delayStatus = ?)
		]]>
	</sql>
</custom-sql>
